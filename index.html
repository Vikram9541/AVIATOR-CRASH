<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
  const config = {
    apiKey: "AIzaSyAGn7jfjUuwHquYv0xEMWOo57kVm0EVzk8",
    authDomain: "aviator-crash-3fdcf.firebaseapp.com",
    databaseURL: "https://aviator-crash-3fdcf-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "aviator-crash-3fdcf",
    storageBucket: "aviator-crash-3fdcf.appspot.com",
    messagingSenderId: "181752775091",
    appId: "1:181752775091:web:d0ef4745359392a12f0bc6"
  };
  firebase.initializeApp(config);

  let auth = firebase.auth();
  let db = firebase.database();
  let user = null;
  let balance = 0;
  let bet = 25;
  let multiplier = 1.0;
  let isBetPlaced = false;
  let crashPoint = 2.0;
  let historyList = [];
  let currentFlight = 0;
  let gameInterval = null;

  // Load history crash numbers
  fetch('assets/history_numbers.txt')
    .then(res => res.text())
    .then(text => {
      historyList = text.trim().split('\n').map(Number);
      startFlight();
    });

  function updateUI() {
    document.getElementById('balance').textContent = `Balance: ₹${balance}`;
    document.getElementById('betLabel').textContent = `Bet: ₹${bet}`;
  }

  function signIn() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).then(result => {
      user = result.user;
      document.getElementById('loginBtn').style.display = 'none';
      db.ref('users/' + user.uid + '/balance').once('value').then(snap => {
        balance = snap.val() || 0;
        updateUI();
      });
    });
  }

  function saveBalance() {
    if (user) {
      db.ref('users/' + user.uid + '/balance').set(balance);
    }
  }

  function deposit() {
    if (!user) return alert('Login first');
    let amt = prompt('Enter deposit amount');
    if (!amt || isNaN(amt)) return alert('Invalid amount');
    db.ref('requests/deposit/' + user.uid).set({ amount: amt, upi: 'vikram95@kotak' });
    alert('Deposit request sent to admin.');
  }

  function withdraw() {
    if (!user) return alert('Login first');
    let amt = prompt('Enter withdrawal amount');
    let upi = prompt('Enter your UPI ID');
    if (!amt || !upi) return alert('Invalid details');
    db.ref('requests/withdraw/' + user.uid).set({ amount: amt, upi });
    alert('Withdrawal request sent to admin.');
  }

  function changeBet(delta) {
    let newBet = bet + delta;
    if (newBet >= 25 && newBet <= balance) {
      bet = newBet;
      updateUI();
    }
  }

  function placeBet() {
    if (isBetPlaced) return;
    if (balance >= bet) {
      balance -= bet;
      isBetPlaced = true;
      updateUI();
    } else {
      alert('Not enough balance');
    }
  }

  function cashOut() {
    if (isBetPlaced) {
      const win = Math.round(bet * multiplier);
      balance += win;
      alert(`Cashed out ₹${win}`);
      updateUI();
      isBetPlaced = false;
      saveBalance();
    }
  }

  function startFlight() {
    let plane = document.getElementById('plane');
    multiplier = 1.0;
    plane.style.bottom = '0px';
    crashPoint = historyList[currentFlight % historyList.length];
    document.getElementById('multiplier').textContent = `${multiplier.toFixed(2)}x`;

    gameInterval = setInterval(() => {
      multiplier += 0.05;
      plane.style.bottom = `${multiplier * 10}px`;
      document.getElementById('multiplier').textContent = `${multiplier.toFixed(2)}x`;

      if (multiplier >= crashPoint) {
        clearInterval(gameInterval);
        if (isBetPlaced) {
          alert(`Plane crashed at ${crashPoint}x. You lost ₹${bet}`);
          isBetPlaced = false;
          saveBalance();
        } else {
          console.log('No bet placed this round.');
        }
        currentFlight++;
        setTimeout(startFlight, 5000); // Wait 5 seconds before next round
      }
    }, 100);
  }
</script>
